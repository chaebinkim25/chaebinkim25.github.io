<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI í¬í„¸ (HTML + JS, GitHub Pages)</title>
  <style>
    :root {
      --bg: #0b0f14; --panel:#121821; --muted:#94a3b8; --text:#e5e7eb; --accent:#60a5fa; --card:#0f172a; --border:#1f2a37;
    }
    * { box-sizing: border-box }
    html, body { height: 100%; }
    body { margin:0; background:var(--bg); color:var(--text); font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans, Apple SD Gothic Neo, sans-serif; }
    .app { display:grid; grid-template-columns: 260px 1fr 320px; grid-template-rows:auto 1fr auto; gap:12px; padding:12px; height:100%; }
    header { grid-column:1/4; display:flex; align-items:center; gap:10px; background:var(--panel); border:1px solid var(--border); border-radius:14px; padding:10px 14px; }
    header h1 { font-size:16px; margin:0; letter-spacing: 0.2px; }
    header .grow { flex:1 }
    .btn, button { background:#0b1220; border:1px solid var(--border); color:var(--text); padding:8px 10px; border-radius:10px; cursor:pointer; }
    .btn.primary { background:var(--accent); color:#0b1220; border:none; }
    .col { background:var(--panel); border:1px solid var(--border); border-radius:14px; overflow:hidden; display:flex; flex-direction:column; min-height:0; }
    .col h3 { margin:0; padding:10px 12px; border-bottom:1px solid var(--border); color:#cbd5e1; font-size:13px; letter-spacing:.3px; text-transform:uppercase }
    .sources { padding:10px; gap:8px; display:flex; flex-direction:column; }
    .tag { display:inline-flex; padding:6px 8px; border:1px solid var(--border); border-radius:999px; align-items:center; gap:6px; color:var(--muted); cursor:pointer; }
    .tag input { margin:0 }
    .chat { display:flex; flex-direction:column; }
    .messages { flex:1; overflow:auto; padding:16px; display:flex; flex-direction:column; gap:12px; }
    .msg { display:flex; gap:10px; }
    .msg .bubble { max-width: 80%; background:var(--card); border:1px solid var(--border); padding:10px 12px; border-radius:12px; white-space:pre-wrap; word-break: break-word; }
    .msg.user .bubble { background:#162033; border-color:#253046 }
    .msg .avatar { width:28px; height:28px; border-radius:999px; background:#0e1525; border:1px solid var(--border); display:grid; place-items:center; font-size:12px; color:#93c5fd }
    .composer { display:flex; gap:8px; padding:12px; border-top:1px solid var(--border) }
    .composer textarea { flex:1; resize:none; height:66px; padding:10px 12px; border-radius:10px; border:1px solid var(--border); background:#0e1525; color:var(--text); }
    .right { display:flex; flex-direction:column }
    .right .panel { padding:10px; overflow:auto; }
    .kv { display:grid; grid-template-columns: 120px 1fr; gap:6px 10px; align-items:center; }
    .kv label { color:var(--muted); font-size:12px }
    .input { background:#0e1525; border:1px solid var(--border); border-radius:10px; padding:8px 10px; color:var(--text); width:100% }
    .range { width:100% }
    .pill { font-size:12px; color:var(--muted); padding:6px 8px; border:1px dashed var(--border); border-radius:8px; }
    .note { color:#93c5fd; font-size:12px }
    .cite { color:#9ca3af; font-size:12px; border-left:2px solid #1f2937; padding-left:8px; margin:6px 0 }
    footer { grid-column:1/4; text-align:center; color:var(--muted); font-size:12px }
    .danger { color:#fca5a5 }
    .ok { color:#86efac }
    .flex { display:flex; gap:8px; align-items:center }
    @media (max-width: 1100px){ .app{ grid-template-columns:1fr; grid-template-rows:auto auto 1fr auto auto } .col.right{ order:3 } }
  </style>
</head>
<body>
<div class="app">
  <header>
    <h1>AI í¬í„¸ (HTML+JS)</h1>
    <div class="grow"></div>
    <select id="model" class="input" style="max-width:220px">
      <option value="gpt-4o-mini">gpt-4o-mini</option>
      <option value="gpt-4.1">gpt-4.1</option>
      <option value="claude-3.7-sonnet">claude-3.7-sonnet</option>
    </select>
    <button id="btnSettings" class="btn">ì„¤ì •</button>
    <button id="btnClear" class="btn">ëŒ€í™” ì´ˆê¸°í™”</button>
  </header>

  <section class="col">
    <h3>ë°ì´í„° ì†ŒìŠ¤</h3>
    <div class="sources">
      <label class="tag"><input type="checkbox" id="srcWeb" checked>ì›¹ ê²€ìƒ‰ í—ˆìš©</label>
      <label class="tag"><input type="checkbox" id="srcRag">RAG(ë‚´ ë¬¸ì„œ)</label>
      <div class="pill">GitHub PagesëŠ” **ì •ì  í˜¸ìŠ¤íŒ…**ì…ë‹ˆë‹¤. RAG/ê²€ìƒ‰/LLM í˜¸ì¶œì€ <span class="note">ì™¸ë¶€ í”„ë¡ì‹œ API</span>ê°€ í•„ìš”í•©ë‹ˆë‹¤.</div>
      <div class="flex">
        <input id="ragQuery" class="input" placeholder="ë¬¸ì„œ ê²€ìƒ‰ì–´ (ì„ íƒ)" />
        <button id="btnRag" class="btn">ê²€ìƒ‰</button>
      </div>
      <small class="note">RAG í™œì„± ì‹œ, ë°±ì—”ë“œê°€ `/rag/query`ë¥¼ ì œê³µí•´ì•¼ í•©ë‹ˆë‹¤.</small>
    </div>
  </section>

  <main class="col chat">
    <div id="messages" class="messages"></div>
    <div class="composer">
      <textarea id="input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”. (Shift+Enter ì¤„ë°”ê¿ˆ)"></textarea>
      <button id="send" class="btn primary">ë³´ë‚´ê¸° â</button>
    </div>
  </main>

  <aside class="col right">
    <h3>ì„¤ì • & ìƒíƒœ</h3>
    <div class="panel">
      <div class="kv">
        <label>í”„ë¡ì‹œ API</label>
        <input id="apiBase" class="input" placeholder="https://your-worker.example.com" />
        <label>ì˜¨ë„(ì°½ì˜ì„±)</label>
        <input id="temp" class="range" type="range" min="0" max="1" step="0.05" value="0.4" />
        <label>ê¸¸ì´ ì œí•œ</label>
        <input id="maxTokens" class="input" type="number" value="800" />
      </div>
      <div id="status" class="pill" style="margin-top:10px">ìƒíƒœ: ëŒ€ê¸°</div>
      <details style="margin-top:10px">
        <summary>ì¸ìš©/ê·¼ê±°</summary>
        <div id="citations"></div>
      </details>
      <details style="margin-top:10px">
        <summary>ê°€ì´ë“œ</summary>
        <div class="cite">
          GitHub Pagesì—ì„œëŠ” ë¹„ë°€í‚¤ë¥¼ ì ˆëŒ€ ë…¸ì¶œí•˜ì§€ ë§ˆì„¸ìš”. 
          Cloudflare Workers/Vercel Functions ë“±ìœ¼ë¡œ **í”„ë¡ì‹œ ì—”ë“œí¬ì¸íŠ¸**ë¥¼ ë§Œë“  ë’¤, ì—¬ê¸°ì— URLë§Œ ì—°ê²°í•˜ì„¸ìš”.
        </div>
      </details>
    </div>
  </aside>

  <section class="col right">
    <h3>ğŸ§  ìµœì‹  AI ëª¨ë¸</h3>
    <div class="panel">
      <div class="flex" style="margin:6px 0 10px 0">
        <select id="aiCatFilter" class="input" style="max-width:180px">
          <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
          <option>í…ìŠ¤íŠ¸</option>
          <option>ì½”ë“œ</option>
          <option>ë¹„ì „</option>
          <option>ì˜¤ë””ì˜¤/ìŒì„±</option>
          <option>ë©€í‹°ëª¨ë‹¬</option>
          <option>ì˜¤í”ˆì†ŒìŠ¤</option>
        </select>
        <label class="tag"><input id="aiFreeOnly" type="checkbox">ë¬´ë£Œ/í”„ë¦¬í‹°ì–´ë§Œ</label>
      </div>
      <div id="aiList"></div>
    </div>
  </section>

  <footer>
    Â© 2025 AI Portal â€¢ HTML + JavaScript â€¢ GitHub Pages ë°°í¬ìš©
  </footer>
</div>

<script>
  /**
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ìµœì†Œ í”„ë¡ì‹œ API ê·œê²© (ì˜ˆì‹œ)
   * POST {API_BASE}/chat  â†’  { messages:[{role,content}], model, temperature, max_tokens, sources:{web, rag, rag_query} }
   *   â†³ Stream(text) ë˜ëŠ” JSON({text, citations:[{title,url}...]}) ë°˜í™˜
   * POST {API_BASE}/rag/query â†’ { q }  â†³ JSON({hits:[{title, snippet, url}]})
   * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   * ê°„ë‹¨í•œ Cloudflare Worker ì˜ˆì‹œ (TypeScript)
   * export default {
   *  async fetch(req) {
   *    const body = await req.json();
   *    const r = await fetch('https://api.openai.com/v1/chat/completions', {
   *      method:'POST', headers:{'Authorization':`Bearer ${OPENAI_KEY}`,'Content-Type':'application/json'},
   *      body: JSON.stringify({model: body.model, messages: body.messages, temperature: body.temperature, max_tokens: body.max_tokens})
   *    });
   *    return new Response(r.body, { headers:{'Content-Type':'text/plain'} }); // ë‹¨ìˆœ í”„ë¡ì‹œ(ìŠ¤íŠ¸ë¦¬ë°)
   *  }
   * }
   */

  const els = {
    messages: document.getElementById('messages'),
    input: document.getElementById('input'),
    send: document.getElementById('send'),
    model: document.getElementById('model'),
    btnSettings: document.getElementById('btnSettings'),
    btnClear: document.getElementById('btnClear'),
    apiBase: document.getElementById('apiBase'),
    temp: document.getElementById('temp'),
    maxTokens: document.getElementById('maxTokens'),
    status: document.getElementById('status'),
    citations: document.getElementById('citations'),
    srcWeb: document.getElementById('srcWeb'),
    srcRag: document.getElementById('srcRag'),
    ragQuery: document.getElementById('ragQuery'),
    btnRag: document.getElementById('btnRag')
  };

  const state = {
    apiBase: localStorage.getItem('apiBase') || '',
    messages: [],
    streaming: false
  };
  els.apiBase.value = state.apiBase;

  function setStatus(text, ok=false){
    els.status.textContent = 'ìƒíƒœ: ' + text;
    els.status.className = 'pill ' + (ok ? 'ok' : '');
  }

  function addMessage(role, content){
    const wrap = document.createElement('div');
    wrap.className = 'msg ' + role;
    const avatar = document.createElement('div');
    avatar.className = 'avatar';
    avatar.textContent = role === 'user' ? 'U' : 'A';
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.textContent = content;
    wrap.appendChild(avatar); wrap.appendChild(bubble);
    els.messages.appendChild(wrap);
    els.messages.scrollTop = els.messages.scrollHeight;
  }

  function updateLastAssistantChunk(text){
    const last = els.messages.querySelector('.msg.assistant:last-child .bubble');
    if (last) last.textContent = text;
  }

  function startAssistant(){ addMessage('assistant', ''); }

  async function sendChat(){
    const content = els.input.value.trim();
    if(!content) return;
    if(!els.apiBase.value){ setStatus('í”„ë¡ì‹œ APIë¥¼ ì„¤ì •í•˜ì„¸ìš”', false); alert('ì„¤ì • â†’ í”„ë¡ì‹œ API URLì´ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
    setStatus('ìš”ì²­ ì¤‘â€¦');
    addMessage('user', content);
    els.input.value = '';

    const payload = {
      model: els.model.value,
      temperature: parseFloat(els.temp.value),
      max_tokens: parseInt(els.maxTokens.value || '800'),
      messages: [...state.messages, { role:'user', content }],
      sources: { web: els.srcWeb.checked, rag: els.srcRag.checked, rag_query: els.ragQuery.value || '' }
    };

    // ë¡œì»¬ ìƒíƒœ ê°±ì‹ 
    state.messages.push({ role:'user', content });
    startAssistant();

    try{
      const res = await fetch(cleanJoin(els.apiBase.value, '/chat'), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });

      // ìŠ¤íŠ¸ë¦¬ë° í…ìŠ¤íŠ¸(plain) ì²˜ë¦¬
      if(res.body && res.headers.get('Content-Type')?.includes('text')){
        state.streaming = true; let acc='';
        const reader = res.body.getReader();
        while(true){
          const {done, value} = await reader.read();
          if(done) break; acc += new TextDecoder().decode(value);
          updateLastAssistantChunk(acc);
        }
        state.streaming = false;
        state.messages.push({ role:'assistant', content: acc });
        setStatus('ì™„ë£Œ', true);
        return;
      }

      // JSON({ text, citations }) ì²˜ë¦¬
      const data = await res.json();
      const text = data.text || (data.output?.content ?? '[ë¹ˆ ì‘ë‹µ]');
      updateLastAssistantChunk(text);
      state.messages.push({ role:'assistant', content: text });
      renderCitations(data.citations || []);
      setStatus('ì™„ë£Œ', true);
    }catch(err){
      updateLastAssistantChunk('âš ï¸ ì˜¤ë¥˜: ' + err.message);
      setStatus('ì‹¤íŒ¨');
    }
  }

  function renderCitations(items){
    els.citations.innerHTML = '';
    if(!items.length){ els.citations.textContent = 'â€”'; return; }
    for(const c of items){
      const div = document.createElement('div');
      div.className = 'cite';
      const a = document.createElement('a'); a.href = c.url; a.textContent = c.title || c.url; a.target = '_blank';
      div.appendChild(a); els.citations.appendChild(div);
    }
  }

  function cleanJoin(base, path){
    return base.replace(/\/$/, '') + path;
  }

  // ì´ë²¤íŠ¸ ë°”ì¸ë”©
  els.send.addEventListener('click', sendChat);
  els.input.addEventListener('keydown', (e)=>{
    if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendChat(); }
  });
  els.btnClear.addEventListener('click', ()=>{ state.messages=[]; els.messages.innerHTML=''; renderCitations([]); setStatus('ëŒ€í™” ì´ˆê¸°í™”ë¨', true); });
  els.btnSettings.addEventListener('click', ()=>{ const v = prompt('í”„ë¡ì‹œ API URLì„ ì…ë ¥í•˜ì„¸ìš”', els.apiBase.value || ''); if(v!==null){ els.apiBase.value=v; localStorage.setItem('apiBase', v); setStatus('ì„¤ì • ì €ì¥ë¨', true);} });
  els.apiBase.addEventListener('change', ()=>{ localStorage.setItem('apiBase', els.apiBase.value); });
  els.btnRag.addEventListener('click', async ()=>{
    if(!els.apiBase.value){ alert('í”„ë¡ì‹œ API URL í•„ìš”'); return; }
    const q = els.ragQuery.value.trim(); if(!q) return;
    setStatus('RAG ê²€ìƒ‰ ì¤‘â€¦');
    try{
      const r = await fetch(cleanJoin(els.apiBase.value, '/rag/query'), {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ q })});
      const data = await r.json();
      const hits = data.hits || [];
      renderCitations(hits.map(h=>({ title: h.title || h.url, url: h.url })));
      setStatus(`RAG ê²°ê³¼ ${hits.length}ê±´`, true);
    }catch(e){ setStatus('RAG ì‹¤íŒ¨'); alert(e.message); }
  });

  // í™˜ì˜ ë©”ì‹œì§€
  addMessage('assistant', 'ì•ˆë…•í•˜ì„¸ìš”! GitHub Pagesì—ì„œ ë™ì‘í•˜ëŠ” HTML+JS AI í¬í„¸ í…œí”Œë¦¿ì…ë‹ˆë‹¤. ì„¤ì • ë²„íŠ¼ì—ì„œ í”„ë¡ì‹œ API URLì„ ì…ë ¥í•˜ê³  ì‹œì‘í•˜ì„¸ìš”.');

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // ìµœì‹  AI ëª¨ë¸ ë¡œë“œ (models.json, ì •ì  íŒŒì¼)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let ALL_MODELS = [];
  function renderModels(){
    const box = document.getElementById('aiList');
    const cat = document.getElementById('aiCatFilter')?.value || '';
    const freeOnly = document.getElementById('aiFreeOnly')?.checked;
    box.innerHTML='';
    const items = ALL_MODELS.filter(m=>{
      const okCat = !cat || (Array.isArray(m.category)? m.category.includes(cat) : m.category===cat);
      const okFree = !freeOnly || (!!m.price?.free || (m.price?.trial===true));
      return okCat && okFree;
    });
    if(!items.length){ box.textContent = 'í•´ë‹¹ ì¡°ê±´ì˜ ëª¨ë¸ì´ ì—†ìŠµë‹ˆë‹¤.'; return; }
    for(const m of items){
      const price = formatPrice(m.price);
      const cats = Array.isArray(m.category)? m.category.join(', ') : (m.category||'');
      const div = document.createElement('div');
      div.className = 'cite';
      div.innerHTML = `
        <b>${m.name}</b> <small>(${m.org}${m.date?`, ${m.date}`:''}${cats?`, ${cats}`:''})</small><br>
        ${m.desc || ''}<br>
        <span class="pill">${price}</span>
        <a href="${m.url}" target="_blank" style="margin-left:8px">ğŸ”— ìì„¸íˆ ë³´ê¸°</a>
      `;
      box.appendChild(div);
    }
  }

  function formatPrice(p){
    if(!p) return 'ê°€ê²© ì •ë³´ ì—†ìŒ';
    // ì˜ˆ: { free:true, input:"$3/1M tok", output:"$15/1M tok" }
    const fr = p.free ? 'ë¬´ë£Œ' : (p.trial? 'ì²´í—˜íŒ' : 'ìœ ë£Œ');
    const parts = [];
    if(p.input) parts.push(`ì…ë ¥ ${p.input}`);
    if(p.output) parts.push(`ì¶œë ¥ ${p.output}`);
    if(p.image) parts.push(`ì´ë¯¸ì§€ ${p.image}`);
    if(p.audio) parts.push(`ì˜¤ë””ì˜¤ ${p.audio}`);
    return [fr, parts.join(' Â· ')].filter(Boolean).join(' â€” ');
  }

  async function loadModels(){
    try{
      const res = await fetch('models.json', { cache: 'no-cache' });
      const items = await res.json();
      ALL_MODELS = Array.isArray(items) ? items : [];
      renderModels();
    }catch(e){
      const box = document.getElementById('aiList');
      box.classList.add('danger');
      box.textContent = 'ëª¨ë¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + e.message;
    }
  }

  // í•„í„° ì´ë²¤íŠ¸
  document.addEventListener('change', (e)=>{
    if(e.target && (e.target.id==='aiCatFilter' || e.target.id==='aiFreeOnly')){
      renderModels();
    }
  });

  loadModels();
</script>
</body>
</html>
